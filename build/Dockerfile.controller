# Stage 1: Builder
# UPDATED: Using Go 1.25 to match your local go.mod
FROM golang:1.25 AS builder
WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .
# Using CGO because of SQLite
RUN CGO_ENABLED=1 GOOS=linux go build -ldflags="-s -w" -o controller cmd/controller/main.go

# Stage 2: Runtime (Distroless with glibc for SQLite)
FROM gcr.io/distroless/base-debian12
COPY --from=builder /app/controller /

EXPOSE 50051
CMD ["/controller"]
